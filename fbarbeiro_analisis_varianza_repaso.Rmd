---
title: "Estadística Avanzada<br /><br /><u>Actividad 4</u><br /> <h2>Análisis de varianza y repaso del curso</h2>"
author: "Fernando Antonio Barbeiro Campos - fbarbeiro@uoc.edu"

date: '`r format(Sys.Date(),"%e %B, %Y")`<hr />'
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
```

<hr />

## 1. Preprocesado
###1.1. Carga de datos
Cargar el fichero de datos “Fumadores.csv”.
```{r}
df <- read.csv("data/Fumadores.csv")
head(df)
```

###1.2. Tipos de datos
<p style="text-align: justify">Consultar los tipos de datos de las variables y si es necesario, aplicar las conversiones apropiadas. Averiguar posibles inconsistencias en los valores de Tipo o AE. En caso de que existan inconsitencias, corregidlas.
</p>
```{r}
# Buscando por valores NA
print(unlist(lapply(df, function(x) any(is.na(x)))))

# Reunindo los tipos de variables e imprimindo
res <- sapply(df, class)
kable(data.frame(variables=names(res),clase=as.vector(res)))

summary(df) # se nota (Other) en Tipo, deberíamos tener solo 6 categorías

unique(df$Tipo) # Claramente el problema ha sido detectado - 2 letras minusculas
df <- as.data.frame(sapply(df, toupper))
# Aunque va enseñar solo 2 decimales, R mantiene el número como él era inicialmente
df$AE <- as.numeric(as.character(df$AE))

print(head(df$AE))
str(df)
```

###1.3. Realizar un análisis descriptivo de la muestra en su totalidad en relación a la variable AE
Recordando que la estadística descriptiva se trata de resumir los datos de una muestra (en vez de extraer conclusiones).
```{r}
kable(summary(df)[,1], # 1 posicion AE
      digits=2, align='l', caption="Estadística descriptiva de la variable AE", col.names = "AE")
```

###1.4. Analizar los datos según el tipo de fumador
<p style="text-align: justify">
Mostrar el número de personas en cada tipo de fumador, la media de AE de cada tipo de fumador y un gráfico que muestre esta media. Se recomienda ordenar el gráfico de menos a más AE.
</p>
<p style="text-align: justify">
Luego, se debe representar un boxplot donde se muestre la distribución de AE por cada tipo. Para calcular la media o otras variables para cada tipo de fumador, podéis usar las funciones **summarize** y **group_by** de la libreria **dplyr** que os serán de gran utilidad. Para realizar la visualización de los datos, podéis usar la función **ggplot** de la librería **ggplot2**.
</p>
```{r}
library(ggplot2) # ggplot
category <-  as.data.frame(table(df$Tipo))
category
p <- ggplot(category, aes(x = '', y = Freq, fill = factor(Var1)) ) + geom_bar(width = 1,stat="identity") + coord_polar(theta = "y") +
geom_text(aes(label = Freq), position = position_stack(vjust = 0.5)) + ggtitle("Distibución por Tipo de Fumador")

p + labs(fill = "Tipo Fumador", x ="", y = "Frecuencia de ocurrencias")
###### - distribucion ended ####################

r2 <- setNames(aggregate(df[, c("AE")], list(df$Tipo), mean), c("Tipo", "Media"))
r2 <- r2[order(r2$Media),]
r2

barp <- ggplot(r2, aes(x= reorder(Tipo, Media), y=Media, fill=Tipo, label = format(round(Media, 2), nsmall = 2))) + geom_bar(stat="identity")
barp + ggtitle("Tipo de fumadores") + geom_text(size = 3, position = position_stack(vjust = 0.5))
###### - media por tipo de fumador ended ####################

bp <- ggplot(df, aes(x=Tipo, y=AE, fill=Tipo)) + geom_boxplot()
bp + ggtitle("Distribución Aire Expulsado AE por Tipo de Fumador")
```
<br />Se nota la existencia de *outliers* en FI y FM.
<hr />

## 2. Intervalo de confianza
<p style="text-align: justify">
Calcular el intervalo de confianza de la capacidad pulmonar de toda la muestra. El nivel de confianza es 95 %. Realizar el cálculo manualmente sin usar las funciones t.test o equivalentes. Podéis usar qnorm, qt, pnorm, pt, . . . En cuanto a la elección del método para el cálculo del intervalo de confianza, debéis justificar vuestra elección.
</p>
```{r}
n <- length(df$AE)
m <- mean(df$AE)

conf.level <- 0.95
z <- qt((1+conf.level)/2, df=n-1)
se <- sd(df$AE)/sqrt(n)
ci <- z * se

range_min <- m - ci
range_max <- m + ci

print(paste("Intervalo de confianza: ", range_min, " hasta ", range_max))

# Confirmando el valor
confirm <- t.test(df$AE, mu=5.0, conf.level = conf.level)
confirm$conf.int
```

Para calcular el intervalo de confianza he utilizado una formula según Rumsey (2016) [1]:

##### average +- z-score * standardError

Con el uso de la formula de Rumsey (y también confirmado por `t.test`),  con 95% de confianza, la cantidad de aire expulsado (AE) está entre `r range_min` y `r range_max`, con base en el muestreo de datos.

<hr />
## 3. Comparación de dos muestras: Fumadores vs No Fumadores
## 4. ANOVA
## 5. Comparaciones múltiples
## 6. ANOVA multifactorial
## 7. Aplicación de ANOVA a la investigación en minería de datos


<hr>
## Referencias
<p style="text-align: justify">
[1] Rumsey, D. (2016) *"How to calculate a confidence interval for a population mean when you know its standard deviation"*. [artículo en línea]. [Fecha de consulta: 06 de junio del 2018]. 
http://www.dummies.com/education/math/statistics/how-to-calculate-a-confidence-interval-for-a-population-mean-when-you-know-its-standard-deviation/
</p>