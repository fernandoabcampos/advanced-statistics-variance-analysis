---
title: "Estadística Avanzada<br /><br /><u>Actividad 4</u><br /> <h2>Análisis de varianza y repaso del curso</h2>"
author: "Fernando Antonio Barbeiro Campos - fbarbeiro@uoc.edu"

date: '`r format(Sys.Date(),"%e %B, %Y")`<hr />'
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
```

<hr />

## 1. Preprocesado
###1.1. Carga de datos
Cargar el fichero de datos “Fumadores.csv”.
```{r}
df <- read.csv("data/Fumadores.csv")
head(df)
```

###1.2. Tipos de datos
<p style="text-align: justify">Consultar los tipos de datos de las variables y si es necesario, aplicar las conversiones apropiadas. Averiguar posibles inconsistencias en los valores de Tipo o AE. En caso de que existan inconsitencias, corregidlas.
</p>
```{r}
# Buscando por valores NA
print(unlist(lapply(df, function(x) any(is.na(x)))))

# Reunindo los tipos de variables e imprimindo
res <- sapply(df, class)
kable(data.frame(variables=names(res),clase=as.vector(res)))

summary(df) # se nota (Other) en Tipo, deberíamos tener solo 6 categorías

unique(df$Tipo) # Claramente el problema ha sido detectado - 2 letras minusculas
df <- as.data.frame(sapply(df, toupper))
# Aunque va enseñar solo 2 decimales, R mantiene el número como él era inicialmente
df$AE <- as.numeric(as.character(df$AE))

print(head(df$AE))
str(df)
```

###1.3. Realizar un análisis descriptivo de la muestra en su totalidad en relación a la variable AE
Recordando que la estadística descriptiva se trata de resumir los datos de una muestra (en vez de extraer conclusiones).
```{r}
kable(summary(df)[,1], # 1 posicion AE
      digits=2, align='l', caption="Estadística descriptiva de la variable AE", col.names = "AE")
```

###1.4. Analizar los datos según el tipo de fumador
<p style="text-align: justify">
Mostrar el número de personas en cada tipo de fumador, la media de AE de cada tipo de fumador y un gráfico que muestre esta media. Se recomienda ordenar el gráfico de menos a más AE.
</p>
<p style="text-align: justify">
Luego, se debe representar un boxplot donde se muestre la distribución de AE por cada tipo. Para calcular la media o otras variables para cada tipo de fumador, podéis usar las funciones **summarize** y **group_by** de la libreria **dplyr** que os serán de gran utilidad. Para realizar la visualización de los datos, podéis usar la función **ggplot** de la librería **ggplot2**.
</p>
```{r}
library(ggplot2) # ggplot
category <-  as.data.frame(table(df$Tipo))
category
p <- ggplot(category, aes(x = '', y = Freq, fill = factor(Var1)) ) + geom_bar(width = 1,stat="identity") + coord_polar(theta = "y") +
geom_text(aes(label = Freq), position = position_stack(vjust = 0.5)) + ggtitle("Distibución por Tipo de Fumador")

p + labs(fill = "Tipo Fumador", x ="", y = "Frecuencia de ocurrencias")
###### - distribucion ended ####################

r2 <- setNames(aggregate(df[, c("AE")], list(df$Tipo), mean), c("Tipo", "Media"))
r2 <- r2[order(r2$Media),]
r2

barp <- ggplot(r2, aes(x= reorder(Tipo, Media), y=Media, fill=Tipo, label = format(round(Media, 2), nsmall = 2))) + geom_bar(stat="identity")
barp + ggtitle("Tipo de fumadores") + geom_text(size = 3, position = position_stack(vjust = 0.5))
###### - media por tipo de fumador ended ####################

bp <- ggplot(df, aes(x=Tipo, y=AE, fill=Tipo)) + geom_boxplot()
bp + ggtitle("Distribución Aire Expulsado AE por Tipo de Fumador")
```
<br />Se nota la existencia de *outliers* en FI y FM.
<hr />

## 2. Intervalo de confianza
<p style="text-align: justify">
Calcular el intervalo de confianza de la capacidad pulmonar de toda la muestra. El nivel de confianza es 95 %. Realizar el cálculo manualmente sin usar las funciones t.test o equivalentes. Podéis usar qnorm, qt, pnorm, pt, . . . En cuanto a la elección del método para el cálculo del intervalo de confianza, debéis justificar vuestra elección.
</p>
```{r}
n <- length(df$AE)
m <- mean(df$AE)

conf.level <- 0.95
z <- qt((1+conf.level)/2, df=n-1)
se <- sd(df$AE)/sqrt(n)
ci <- z * se

range_min <- m - ci
range_max <- m + ci

print(paste("Intervalo de confianza: ", range_min, " hasta ", range_max))

# Confirmando el valor
confirm <- t.test(df$AE, mu=5.0, conf.level = conf.level)
confirm$conf.int
```

Para calcular el intervalo de confianza he utilizado una formula según Rumsey (2016) [1]:

##### average +- z-score * standardError

Con el uso de la formula de Rumsey (y también confirmado por `t.test`),  con 95% de confianza, la cantidad de aire expulsado (AE) está entre `r range_min` y `r range_max`, con base en el muestreo de datos.

<hr />
## 3. Comparación de dos muestras: Fumadores vs No Fumadores
<p style="text-align: justify">
¿Podemos afirmar que la capacidad pulmonar de los fumadores es inferior a la de no fumadores? Incluid dentro de la categoría de no fumadores los fumadores pasivos. Realizar el cálculo manualmente sin usar las funciones `t.test` o equivalentes. Podéis usar `qnorm`, `qt`, `pnorm`, `pt` ... Seguid los pasos que se indican a continuación.
</p>
###3.1. Escribir la hipótesis nula y alternativa
Al escribir la hipótesis nula y alternativa, si se trata de comprobar si la capacidad pulmonar de los fumadores es inferior a la de no fumadores se debe plantear así:<br />
<br />
**H *<sub>0</sub> : &mu; <sub>Capac. Fumadores</sub>* =  *&mu; <sub>Capac. No Fumadores</sub>* **
<br />
**H *<sub>1</sub> : &mu; <sub>Capac. Fumadores</sub>* <  *&mu; <sub>Capac. No Fumadores</sub>* **
<br />
<br />
<p style="text-align: justify">
Es decir, se persigue rechazar la hipótesis nula. Al hacerlo, se hace a favor de la alternativa. H0 siempre es la hipótesis nula, y es la que se formula con la igualdad. (*Ester Bernadó Mansilla, orientaciones Tablero*)
</p>

###3.2. Preparar los datos para realizar el contraste
Creando dos data frames que contengan por separado los no fumadores y por otra parte, los fumadores.
```{r}
nrow(df)
no_fumadores <- subset(df, df$Tipo =="NF" | df$Tipo == "FI") # NF - No Fumadores / FP - Fumadores pasivos
fumadores <- subset(df, df$Tipo !="NF" & df$Tipo != "FI")
head(no_fumadores)
tail(no_fumadores)
head(fumadores)
tail(fumadores)

n1 <- length( no_fumadores$AE)
n2 <- length( fumadores$AE)
n1
n2

s1 <- sd( no_fumadores$AE )
s2 <-sd ( fumadores$AE )
s1
s2
```

###3.3. Especificar qué tipo de contraste usaréis
*Podéis consultar Gibergans Baguena (2009).*

<p style="text-align: justify">
Se trata de un **contraste unilateral**, conforme indicado por Baguena (2009) [2], este tipo de contraste es un **contraste de dos muestras sobre la diferencia de medias**.
<p style="text-align: justify">

###3.4. Realizar los cálculos del valor p
```{r}
mean1 <- mean( no_fumadores$AE )
mean2 <- mean( fumadores$AE )
mean1
mean2

S <- sqrt( s1^2/n1 + s2^2/n2)
zobs <- (mean1-mean2)/ S
zobs

alfa <- 1-0.95
zcritical <- qnorm( alfa, lower.tail=FALSE )
zcritical

pvalue <- pnorm( abs(zobs), lower.tail=FALSE )
pvalue
```



###3.5. Interpretar el resultado del contraste
<p style="text-align: justify">
Observando pvalue = `r pvalue` < &alpha;=`r alfa`, rechazamos la hipótesis nula *Capacidad Pulmonar Fumadores = Capacidad Pulmonar No Fumadores* a favor de la hipótesis alternativa.
</p>

A partir del valor crítico, también se llega a la misma observación, puesto que el valor observado `r zobs` > `r zcritical`.


## 4. ANOVA
<p style="text-align: justify">
A continuación se realizará un análisis de varianza, donde se desea comparar la capacidad pulmonar entre los seis tipos de fumadores/no fumadores clasificados previamente. El análisis de varianza consiste en evaluar si la variabilidad de una variable dependiente puede explicarse a partir de una o varias variables independientes, denominadas factores. En el caso que nos ocupa, nos interesa evaluar si la variabilidad de la variable AE puede explicarse por el factor tipo de fumador. Hay dos preguntas básicas a responder:
</p>

+ ¿Existen diferencias entre la capacidad pulmonar (AE) entre los distintos tipos de fumadores/no fumadores?
+ Si existen diferencias, ¿entre qué grupos están estas diferencias?

<p style="text-align: justify">
Para la resolución de esta sección, se seguirán los apuntes de López-Roldán y Fachelli (2015).
</p>

###4.1. Verificar la asunción de normalidad
<p style="text-align: justify">
Atendiendo al material, gráfico III. 8.6 y página 25, evaluar si el conjunto de datos cumple las condiciones de aplicación de ANOVA. Seguid los pasos que se indican a continuación.
</p>

####4.1.1. Representar gráficamente la normalidad de la muestra de datos AE con la función qqnorm
```{r}
qqnorm(df$AE)
qqline(df$AE)
#bartlett.test(AE)
```

####4.1.2. Escribir la hipótesis nula e hipótesis alternativa
####4.1.3. Aplicar un test de normalidad
<p style="text-align: justify">
Aplicar un test de normalidad, siguiendo las recomendaciones del material mencionado López-Roldán y Fachelli (2015). Justificar la elección.
</p>
####4.1.4. Interpretar los resultados a partir del gráfico qqnorm y de los valores que devuelve el test.

## 5. Comparaciones múltiples
## 6. ANOVA multifactorial
## 7. Aplicación de ANOVA a la investigación en minería de datos


<hr>
## Referencias
<p style="text-align: justify">
[1] Rumsey, D. (2016) *"How to calculate a confidence interval for a population mean when you know its standard deviation"*. [artículo en línea]. [Fecha de consulta: 06 de junio del 2018]. 
http://www.dummies.com/education/math/statistics/how-to-calculate-a-confidence-interval-for-a-population-mean-when-you-know-its-standard-deviation/
</p>
<br />
<p style="text-align: justify">
[2] Baguena, J. (2009) *“Contraste de Dos Muestras.”* In Estadística, edited by Josep Gibergans Baguena, Angel J. Gil Estallo, and Carles Rovira Escofet. Barcelona: FUOC.
</p>